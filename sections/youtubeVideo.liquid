{{ 'youtubeVideo.css' | asset_url | stylesheet_tag }}
<link rel="stylesheet" href="{{ 'swiper.css' | asset_url }}">
<script src="{{ 'swiper.js' | asset_url }}" defer></script>

<div class="youtube-video">
    <h2 class="youtube-video-title">{{ section.settings.headingTitle }}</h2>
    <div class="youtube-video-swiper">
        <div class="swiper sec1-list2-swiper">
            <div class="swiper-wrapper">
                {% for block in section.blocks %}
                <div class="swiper-slide" {{ block.shopify_attributes }} data-video-url="{{ block.settings.videoUrl }}">
                    <div class="sec1-list2-item">
                        <div class="item-img">
                            <div class="item-img-swiper">
                                <img class="item-img-swiper-img" loading="lazy" src="{{ block.settings.videoThumbnail | image_url }}">
                            </div>
                            <div class="img-btn">
                                <img src="https://cdn.shopify.com/s/files/1/0580/7482/4865/files/triangle-play.png?v=1747991840" alt="Play" width="20px" height="20px">
                            </div>
                            <div class="item-title" style="background-color: {{ block.settings.title_background }}">
                                <span class="bold">{{ block.settings.videoTitle }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="sec1-list2-button-prev" data-direction="prev">
        <img src="https://cdn.shopify.com/s/files/1/0580/7482/4865/files/left.png?v=1750150606" alt="Previous">
    </div>
    <div class="sec1-list2-button-next" data-direction="next">
        <img src="https://cdn.shopify.com/s/files/1/0580/7482/4865/files/right.png?v=1750150606" alt="Next">
    </div>
</div>

<!-- 视频弹框 -->
<div class="youtube-video-show">
    <div class="video-popup-container">
        <div class="play-vedio">
            {% for block in section.blocks %}
                <iframe id="video-{{ forloop.index }}" 
                        class="youtube-iframe" 
                        width="100%" 
                        height="100%" 
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        data-src="https://www.youtube.com/embed/{{ block.settings.videoUrl.id }}?enablejsapi=1">
                </iframe>
            {% endfor %}
        </div>
        <div class="close-btn">
          <img src="https://cdn.shopify.com/s/files/1/0580/7482/4865/files/close_ac33382d-eb6f-46bc-af92-0013b2f924c7.png?v=1750157455" alt="">
        </div>
    </div>
</div>

{% schema %}
    {
      "name": "YouTube Video Section",
      "class": "row",
      "settings": [
        {
          "type": "text",
          "id": "headingTitle",
          "label": "Heading Title",
          "default": "Unboxing & Reviews"
        }
      ],
      "blocks": [
        {
          "type": "video_slide",
          "name": "Video Slide",
          "settings": [
            {
              "type": "image_picker",
              "id": "videoThumbnail",
              "label": "Video Thumbnail"
            },
            {
              "type": "text",
              "id": "videoTitle",
              "label": "Video Title",
              "default": "Product Review"
            },
            {
              "type": "video_url",
              "id": "videoUrl",
              "label": "YouTube Video URL",
              "accept": ["youtube"],
              "default": "https://www.youtube.com/watch?v=T7ME7a10iDA",
              "info": "Paste YouTube video link"
            },
            {
              "type": "color",
              "id": "title_background",
              "label": "Title Background Color",
              "default": "#ebebeb"
            }
          ]
        }
      ],
      "presets": [
        {
          "name": "YouTube Video Section"
        }
      ]
    }
{% endschema %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const mainContent = document.getElementById('main-content');
    const headerEl = document.querySelector('#header');
    const headerWrap = headerEl ? headerEl.parentNode : null;
    const footerEl = document.querySelector('#footer');
    const footerWrap = footerEl ? footerEl.parentNode : null;
    const closeButton = document.querySelector('.close-btn'); // 获取关闭按钮
    const videoPopup = document.querySelector('.youtube-video-show'); // 获取弹窗容器

    // 获取自定义按钮元素
    const prevButton = document.querySelector('.sec1-list2-button-prev');
    const nextButton = document.querySelector('.sec1-list2-button-next');
    
    // 初始化Swiper轮播
    const swiper = new Swiper('.sec1-list2-swiper', {
        slidesPerView: 1, // 默认移动端显示1个
        spaceBetween: 20,
        loop: false,
        touchEventsTarget: 'container',
        breakpoints: {
            768: {
                slidesPerView: 3 // PC端显示3个
            },
            480: {
                slidesPerView: 2 // 平板端显示2个
            }
        }
    });
    
    // 关闭视频弹窗的函数
    function closeVideoPopup() {
        // 暂停所有视频
        document.querySelectorAll('.youtube-iframe').forEach(iframe => {
            if (iframe.src) {
                iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            }
            iframe.style.display = 'none';
        });
        
        // 隐藏弹窗
        videoPopup.classList.remove('active');
        mainContent.style.position = 'static';
        mainContent.style.zIndex = '1';
        headerWrap.style.zIndex = '50';
        footerWrap.style.display = 'block';
        
        // 视频关闭后更新箭头状态
        updateButtons();
    }
    
    // 仅在移动端点击弹窗背景关闭
    videoPopup.addEventListener('click', function(e) {
        if (window.innerWidth < 960 && e.target === this) {
            closeVideoPopup();
        }
    });
    
    // 为自定义按钮添加点击事件
    if (prevButton) {
        prevButton.addEventListener('click', function() {
            swiper.slidePrev();
        });
    }
    
    if (nextButton) {
        nextButton.addEventListener('click', function() {
            swiper.slideNext();
        });
    }
    
    // 鼠标悬停显示/隐藏自定义箭头
    const swiperContainer = document.querySelector('.youtube-video-swiper');
    
    if (prevButton && nextButton) {
        // 默认隐藏按钮
        prevButton.style.opacity = '0';
        nextButton.style.opacity = '0';
        
        // 更新按钮显示状态的函数
        function updateButtons() {
            const slideCount = swiper.slides.length;
            const isMobile = window.innerWidth < 480;       // 小屏移动端
            const isTablet = window.innerWidth >= 480 && window.innerWidth < 768; // 平板端
            const isDesktop = window.innerWidth >= 768;     // PC端
            
            let showThreshold;
            
            // 根据不同屏幕尺寸设置不同的显示阈值
            if (isMobile) {
                showThreshold = 1; // 小屏移动端显示1个，超过1个显示按钮
            } else if (isTablet) {
                showThreshold = 2; // 平板端显示2个，超过2个显示按钮
            } else {
                showThreshold = 3; // PC端显示3个，超过3个显示按钮
            }
            
            const shouldShowButtons = slideCount > showThreshold;
            
            // 显示/隐藏按钮
            if (shouldShowButtons) {
                prevButton.style.opacity = '1';
                nextButton.style.opacity = '1';
            } else {
                prevButton.style.opacity = '0';
                nextButton.style.opacity = '0';
            }
            
            // 禁用边界按钮
            prevButton.disabled = swiper.isBeginning;
            nextButton.disabled = swiper.isEnd;
        }
        
        // 桌面端悬停显示箭头
        if (window.innerWidth > 768) {
            swiperContainer.addEventListener('mouseenter', updateButtons);
            swiperContainer.addEventListener('mouseleave', () => {
                prevButton.style.opacity = '0';
                nextButton.style.opacity = '0';
            });
        } else {
            // 移动端始终显示箭头
            prevButton.style.opacity = '1';
            nextButton.style.opacity = '1';
        }
        
        // 初始化、窗口 resize 和轮播变化时更新按钮状态
        updateButtons();
        window.addEventListener('resize', updateButtons);
        swiper.on('slideChange', updateButtons);
    }
    
    // 视频弹窗功能
    document.querySelectorAll('.img-btn').forEach((btn, index) => {
        btn.addEventListener('click', function() {
            const slide = this.closest('.swiper-slide');
            const videoUrl = slide.dataset.videoUrl;
            const videoId = extractVideoId(videoUrl);
            
            const targetIframe = document.getElementById(`video-${index + 1}`);

            if (!targetIframe.src.includes('youtube.com/embed')) {
                targetIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1&rel=0`;
            } else {
                targetIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
            }
            
            document.querySelectorAll('.youtube-iframe').forEach(iframe => {
                iframe.style.display = 'none';
            });
            targetIframe.style.display = 'block';
            
            // 显示弹窗
            videoPopup.classList.add('active');

            mainContent.style.position = 'relative';
            mainContent.style.zIndex = '100';
            headerWrap.style.zIndex = '99';
            footerWrap.style.display = 'none';
        });
    });
    
    // 点击关闭按钮关闭弹窗
    if (closeButton) {
        closeButton.addEventListener('click', function(e) {
            e.stopPropagation(); // 阻止事件冒泡
            closeVideoPopup();
        });
    }

    // 提取YouTube视频ID
    function extractVideoId(url) {
        if (!url) return 'T7ME7a10iDA';
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : 'T7ME7a10iDA';
    }
});
</script>